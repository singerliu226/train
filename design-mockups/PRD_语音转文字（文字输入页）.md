# PRD：文字输入页新增「语音转文字」按钮（H5）

- **产品**：FuturX「专家思维训练平台」
- **模块**：文字输入（文本速记）
- **版本**：V1.0
- **作者**：产品经理 / 协作：前端、后端、测试、设计
- **日期**：2025-12-30
- **关联设计稿**：`design-mockups/index.html`（包含 3 张 SVG）

---

## 1. 背景与问题
在移动端 H5 场景下，用户“灵感出现→需要快速记录”的时间窗口很短：
- 打字成本高、打断思考，尤其在走路/通勤/会议等场景。
- 现有「文字输入」对“即时记录”支持不足，导致记录延迟、内容丢失或质量下降。

因此需要在不改变主流程（文字输入→提交）的前提下，提供**语音转文字**辅助输入能力。

---

## 2. 目标与成功指标
### 2.1 目标
- **提升输入效率**：用语音替代部分打字，缩短“开始记录”的时间。
- **不打断主流程**：语音为辅助入口，不增加额外页面层级。
- **可控可回退**：转写结果可撤销、可编辑，避免误写入带来挫败。
- **H5 兼容性**：覆盖浏览器/微信 WebView 常见权限与失败场景。

### 2.2 成功指标（建议）
> 实际指标以你们现有数据体系为准
- **入口点击率**：`vtt_click_entry / 文字输入页PV`
- **转写成功率**：`vtt_transcribe_success / vtt_record_stop`
- **语音内容使用率**：转写成功且最终提交中包含转写文本的占比
- **提交转化影响**：语音功能上线后，文字输入页提交率不下降（或提升）
- **负向指标**：权限拒绝率、空结果率、转写失败率可监控并可解释

---

## 3. 需求范围
### 3.1 In Scope（本期做）
- 文字输入页新增**麦克风按钮**（语音转文字入口）
- 录音中**底部面板**：计时、停止并转写、取消
- 转写中状态与失败重试（弱网、超时、服务异常）
- 转写完成后**插入到光标处** + `已转写/撤销` 回退
- 埋点与验收用例

### 3.2 Out of Scope（本期不做）
- 连续对话式录音（边说边实时上屏的流式转写）
- 多语言识别与自动语言检测
- 录音文件管理（保存音频、回放、上传历史）
- 训练记录页的语音入口改造（本期仅在文字输入页）

---

## 4. 用户与使用场景
### 4.1 目标用户
- 需要快速记录灵感/要点的用户：通勤、会议、散步、睡前等。
- 习惯用语音输入的人群（不便打字/屏幕较小）。

### 4.2 核心场景
- **走路/通勤**：单手操作，点一下开始说。
- **会议/讨论**：捕捉即兴观点，减少打字分心。
- **碎片化想法**：想到一句就说一句，快速落盘后再编辑。

---

## 5. 交互与流程（详细）
### 5.1 入口位置与交互
- **位置**：文本输入框右下角内嵌圆形麦克风按钮（见屏幕 1）。
- **触发方式**：**点按**触发（建议）；长按可作为后续优化。
- **微提示**（首次/低频展示）：`点按说话，自动转文字`

### 5.2 状态机（V1）
#### 状态 A：Idle（空闲）
用户点击麦克风按钮 → 进入权限检查。

#### 状态 B：Permission（权限检查）
H5 常用 `navigator.mediaDevices.getUserMedia({ audio: true })`。
- 授权通过 → 进入 Recording
- 拒绝/不可用 → 进入 Error（权限/不支持）

#### 状态 C：Recording（录音中）
用底部面板呈现（见屏幕 2）：
- 标题：`语音转文字`
- 状态：`正在聆听…（请尽量靠近麦克风）`
- 计时：`00:xx`（建议上限 60 秒，可配置）
- 主按钮：`停止并转写`
- 次操作：`取消`

规则：
- 达到 60 秒 → 自动停止并转写（进入 Transcribing）
- 切后台/来电/页面隐藏 → 自动停止，提示“录音已暂停”，回到 Idle（不转写、不插入）

#### 状态 D：Transcribing（转写中）
- 文案：`正在转写…`
- 主按钮置灰（防重复）
- 可保留“取消”（取消=不插入本次结果）

#### 状态 E：Done（完成）
- 默认将转写文本**插入到光标处**；若无光标则追加末尾
- 显示 Chip：`已转写` + `撤销`（撤销仅撤销**本次插入**）
- 若文本非空 → 提交按钮高亮可用（见屏幕 3）

---

## 6. 关键规则（插入、撤销、文本处理）
### 6.1 插入位置优先级
1) 输入框有焦点且存在光标 → 插入到光标处  
2) 输入框无焦点但有内容 → 追加末尾  
3) 输入框为空 → 直接填入  

### 6.2 分隔符策略（避免黏连）
- 若插入点前不是换行/空格：默认补一个**换行**（推荐），或按你们风格补空格。

### 6.3 撤销策略
- 记录 `insertStart/insertEnd/insertText`
- 撤销 = 删除该范围并恢复光标位置
- 若用户已编辑插入片段：
  - 方案 1（简单）：提示 `已编辑，无法一键撤销`
  - 方案 2（强撤销）：仍按范围删除（可能删到用户编辑内容）——不建议 V1 默认

---

## 7. 异常与失败兜底（必须覆盖）
### 7.1 权限被拒绝
提示：
- 标题：`无法使用麦克风`
- 说明：`请在浏览器/微信设置中开启麦克风权限后重试`
- 按钮：`我知道了`（H5 通常无法直达系统设置；如有微信 JS-SDK 引导则另行实现）

### 7.2 环境不支持/未触发授权弹窗
提示：
- `当前环境不支持录音，请在系统浏览器/微信内重试`

### 7.3 无声音/识别为空
提示：
- `未识别到有效语音，请再试一次`（toast）
行为：不插入，回到 Idle。

### 7.4 网络异常/超时
底部面板错误态：
- 标题：`转写失败`
- 说明：`网络不稳定，请重试`
- 主按钮：`重试转写`（若无法复用音频则为 `重新录音`）

### 7.5 服务端错误/配额
提示：
- `服务繁忙，请稍后再试`
- 若有配额：`今日转写次数已用完`

---

## 8. UI/视觉规范（V1）
### 8.1 颜色与样式
- 主色：红色（与现有 FuturX 一致，示例 `#E53935`）
- 主按钮圆角：28（与现有提交按钮一致）
- 麦克风按钮：圆形 68px（直径），投影轻量（避免“浮夸”）

### 8.2 组件清单
- 文本框内嵌按钮：`MicButton`
- 底部面板：`VoiceToTextSheet`
- Chip：`TranscribeChip`（已转写/撤销）

> 具体尺寸以设计稿为准；实现时请遵循“安全区不超出卡片”的原则。

---

## 9. 技术方案（高层，不约束具体实现）
### 9.1 录音
- 首选：`getUserMedia` + `MediaRecorder`（浏览器支持较好）
- 兼容：若 `MediaRecorder` 不可用，需评估替代方案（如 WebAudio 录制），V1 可先做“不可用提示”

### 9.2 转写
- 客户端将音频片段上传至后端转写服务（或第三方 ASR），返回识别文本
- 返回结构建议包含：`text`、`confidence`、`segments`（可选）、`requestId`

### 9.3 安全与隐私
- 明确提示“仅用于本次转写，不默认保存音频”（若真实策略不同请按实际写）
- 服务端需具备风控与鉴权（防滥用、刷接口）

---

## 10. 数据埋点（建议）
> 事件名按你们规范调整
- `vtt_click_entry`：点击入口（属性：`has_text`、`cursor`、`webview`）
- `vtt_permission_result`：权限结果（`granted|denied|unsupported|unknown`）
- `vtt_record_start`：开始录音
- `vtt_record_stop`：停止录音（`duration_ms`、`stop_reason`）
- `vtt_transcribe_result`：转写结果（`success|empty|fail`、`latency_ms`、`text_len`、`error_code`）
- `vtt_undo`：撤销（`undo_success`、`reason`）

---

## 11. 验收标准（测试用例）
### 11.1 正向
- 点击麦克风 → 录音面板出现 → 录音 3-10 秒 → 停止并转写 → 文本插入到光标处 → 出现 `已转写/撤销` → 提交按钮可用。

### 11.2 权限/兼容
- 首次授权允许：可录音并转写成功。
- 拒绝权限：出现提示且不插入内容。
- iOS Safari / 微信 WebView / Android Chrome 至少覆盖你们核心渠道。

### 11.3 失败/边界
- 录音过短：提示空结果，不插入。
- 弱网：转写失败可重试（或提示重新录音）。
- 达到 60 秒自动停止并转写。
- 录音中切后台：自动停止并回到 Idle，不插入。
- 插入后编辑文本：撤销策略行为与 PRD 约定一致。

---

## 12. 发布与灰度建议
- 首期建议 **小流量灰度**（如 5% → 20% → 50% → 100%）
- 关键监控：
  - 入口点击率、转写成功率、失败原因分布
  - 提交率变化、用户停留时长与退出率变化

---

## 13. 风险与对策
- **权限/兼容不一致**：提前做渠道覆盖与降级提示；埋点区分不支持原因。
- **弱网体验差**：支持重试与“重新录音”，避免卡死。
- **误插入导致挫败**：必须提供撤销；V1 默认仅撤销本次插入范围。
- **成本/滥用**：服务端鉴权、限流、配额策略（如有）。

---

## 14. 附录：设计稿与说明
- 预览：`design-mockups/index.html`
- 屏幕 1：`design-mockups/screen1_text_input.svg`
- 屏幕 2：`design-mockups/screen2_recording_sheet.svg`
- 屏幕 3：`design-mockups/screen3_transcribed.svg`
- 方案细节补充：`design-mockups/voice-to-text-spec.md`


