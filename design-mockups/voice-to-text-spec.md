# FuturX「专家思维训练平台」H5：文字输入页新增“语音转文字”方案

本文档对应 `design-mockups/index.html` 中的 3 张设计稿，目标是让前端、测试能直接按此实现与验收。

## 目标与原则
- **更快记录灵感**：用语音替代打字，降低输入门槛与中断成本。
- **不打断主流程**：仍以“文字输入→提交”为主，语音是辅助入口。
- **可控与可回退**：转写结果必须可撤销、可编辑，避免误写入带来挫败。
- **H5 友好**：尽量兼容移动端浏览器/微信 WebView 的权限与失败场景。

## 入口与页面结构
### 入口位置
- **位置**：文本输入框右下角内嵌一个圆形麦克风按钮（参考屏幕 1）。
- **原因**：用户目光聚焦在输入区域；内嵌入口不增加页面层级，也不污染底部导航。

### 初始态
- **按钮状态**：可点击；长按/点按均可（建议点按）。
- **提示文案**（可选微文案气泡）：`点按说话，自动转文字`（首次出现，后续可不展示或按频控展示）。

## 核心交互流程（状态机）
### 状态 1：准备/空闲（Idle）
- 用户点击麦克风按钮 → 进入 **权限检查**。

### 状态 2：权限检查（Permission）
H5 录音通常依赖 `getUserMedia`，在微信 WebView 里还可能涉及 JS-SDK 权限（如果你们接了）。

- **已授权**：进入录音中（Recording）。
- **未授权/被拒绝**：弹出解释弹层（见“失败与异常”）。

### 状态 3：录音中（Recording）
以“底部面板”呈现（屏幕 2），包含：
- **标题**：`语音转文字`
- **状态文案**：`正在聆听…（请尽量靠近麦克风）`
- **计时**：`00:xx`，上限建议 60 秒（可配置）
- **主要按钮**：`停止并转写`
- **次要操作**：`取消`

录音中规则：
- **自动停止**：达到上限自动停止并开始转写。
- **打断处理**：切后台/来电/权限变化 → 自动停止并给出可理解提示。

### 状态 4：转写中（Transcribing）
转写开始后：
- 底部面板状态文案变为 `正在转写…`
- 主按钮置灰（避免重复提交）
- 可保留“取消”（取消=不插入本次结果）

### 状态 5：转写完成（Done）
转写完成后（屏幕 3）：
- **插入规则**：默认**追加到光标处**；如果未聚焦/无光标，则追加到文本末尾，并滚动到插入点。
- **回退能力**：显示一个小 Chip：`已转写` + `撤销`
  - 撤销：仅撤销**本次**插入的文本（用范围标记或快照实现）。
- **提交按钮**：若文本非空 → 高亮可用（红色）。

## 插入与编辑规则（关键细节）
- **插入位置优先级**：
  1) 输入框存在光标位置 → 插入到光标处  
  2) 输入框未聚焦但有内容 → 追加到末尾  
  3) 输入框为空 → 直接填入
- **分隔符**：
  - 若插入点前不是换行/空格，建议自动补一个换行或空格（推荐换行），避免黏连。
  - 默认可加前缀：`（语音）` 不建议，容易“污染”文本；更推荐用“已转写” Chip 标识即可。
- **撤销的实现建议**：
  - 记录 `insertStart`、`insertEnd` 与 `insertText`；撤销即删除该范围并恢复光标。
  - 若用户在插入后编辑了该段文本：撤销提示 `已编辑，无法一键撤销` 或改为“撤销本次插入（可能影响已编辑内容）”。

## 失败与异常处理（必须覆盖）
### 权限被拒绝

- **触发**：浏览器/微信 WebView 拒绝麦克风权限；或用户此前选择“拒绝且不再询问”。
- **表现**：弹出提示（推荐系统弹窗样式或底部弹层），包含：
  - 标题：`无法使用麦克风`
  - 说明：`请在浏览器/微信设置中开启麦克风权限后重试`
  - 主按钮：`去设置`（H5 通常无法直接跳系统设置，可改为 `我知道了`；若微信 JS-SDK 支持引导页，则跳到引导页）
  - 次按钮：`取消`
- **行为**：关闭弹窗后回到 Idle，不插入任何内容。

### 首次点击但没有触发授权弹窗
- **常见原因**：未在“用户手势”回调内调用 `getUserMedia`；或页面在 iframe/不安全环境。
- **提示文案**：`当前环境不支持录音，请在系统浏览器/微信内重试`
- **建议**：埋点区分“无权限弹窗”与“API 不可用”，便于定位。

### 无声音/识别为空
- **触发**：用户录音太短、环境噪音过大、输入音量过低，或识别服务返回空结果。
- **提示**（toast）：`未识别到有效语音，请再试一次`
- **回到**：Idle（不插入）。

### 网络异常/超时
- **触发**：转写请求失败、超时、弱网中断。
- **提示**：底部面板内联错误态：
  - 标题：`转写失败`
  - 说明：`网络不稳定，请重试`
  - 主按钮：`重试转写`（复用上一次录音音频）
  - 次按钮：`取消`
- **兜底**：若无法缓存音频（某些环境限制），则主按钮改为 `重新录音`。

### 服务端错误/次数限制
- **触发**：服务端 5xx、配额不足、风控拦截等。
- **提示**：
  - `服务繁忙，请稍后再试`
  - 若是配额：`今日转写次数已用完`（如有配额策略）
- **策略**：允许用户继续手动输入，不影响提交。

### 切后台/来电/页面跳转
- **策略**：自动停止录音，并提示：
  - `录音已暂停`（toast）
  - 进入 Idle，不转写（避免截断语音导致“半句插入”）

## 文案（可直接给前端）
- **Idle 微提示**：`点按说话，自动转文字`
- **Recording 标题**：`语音转文字`
- **Recording 状态**：`正在聆听…（请尽量靠近麦克风）`
- **Recording 主按钮**：`停止并转写`
- **Transcribing 状态**：`正在转写…`
- **空结果**：`未识别到有效语音，请再试一次`
- **网络失败**：`网络不稳定，请重试`
- **完成 Chip**：`已转写` / `撤销`

## 埋点（事件建议）
> 事件名仅建议，按你们现有埋点规范落地即可。

- **`vtt_click_entry`**：点击麦克风入口
  - 属性：`page=文字输入`、`has_text`、`cursor_position`（有/无）
- **`vtt_permission_result`**：权限结果
  - 属性：`result=granted|denied|unsupported|unknown`、`ua`、`webview=wx|browser`
- **`vtt_record_start`**：开始录音
- **`vtt_record_stop`**：停止录音
  - 属性：`duration_ms`、`stop_reason=manual|timeout|interrupt`
- **`vtt_transcribe_result`**：转写结果
  - 属性：`result=success|empty|fail`、`latency_ms`、`text_len`、`error_code`
- **`vtt_undo`**：点击撤销
  - 属性：`undo_success=true|false`、`reason=edited|range_missing`

## 验收清单（测试用例）
### 正向流程
- 点击麦克风 → 录音面板出现 → 录音 3-10 秒 → 停止并转写 → 文本追加到光标处 → `已转写/撤销` 出现 → 提交按钮变为可用。

### 权限与兼容
- 首次点击弹出授权：允许后可录音；拒绝后出现“无法使用麦克风”提示且不插入内容。
- iOS Safari/微信 WebView/Android Chrome 下分别验证（至少覆盖你们主要渠道）。

### 失败与边界
- 录音 0.5 秒：提示“未识别到有效语音”。
- 弱网/断网：转写失败可重试（或提示重新录音）。
- 达到 60 秒自动停止并转写。
- 录音中切后台：自动停止且不转写、不插入。
- 转写完成后用户编辑文本：点击撤销的行为符合“撤销策略”约定（可撤销 or 提示已编辑）。

## 设计稿文件
- `design-mockups/screen1_text_input.svg`：新增入口位置
- `design-mockups/screen2_recording_sheet.svg`：录音中面板
- `design-mockups/screen3_transcribed.svg`：完成态 + 撤销


